<koe-ui-basicchat>

    <!--***********************************************************-->

    <!-- Google Material Icon -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <div class="messagesBox">

        <div class="message _welcome">
            <span>Hi, I am a bot! How are you?</span>
        </div>

        <div each="{ msgObj.messages }">
            <div class="message {filter_me( from )}">
                <span>{ text }</span>
            </div>
        </div>

    </div>

    <div>
        <form onsubmit="{ send_and_polling }">
            <input type="text" onkeyup="{ edit }">
            <button disabled="{ !text }">
                <i class="material-icons">send</i>
            </button>
        </form>
    </div>


    <!--***********************************************************-->

    <style scoped>
        :scope {
            display: block;
            border: 2px solid #d9d9d9;
            border-radius: 7px;
            padding: 10px;
            box-sizing: border-box;
        }
        * {
            box-sizing: border-box;
        }
        .messagesBox {
            display: block;
            padding: 10px;
            height: 200px;
            margin-bottom: 10px;
            overflow: auto;
        }
        .message {
            margin: 10px;
        }
        .message > span {
            display: inline-block;
            background: #F1F0F0;
            padding: 5px 15px;
            border-radius: 20px;
        }
        .message._me {
            text-align: right;
        }
        .message._me > span {
            color: #fff;
            background: #41e667;
        }
        form {
            display: block;
            position: relative;
        }
        input {
            display: block;
            width: 100%;
            border: 2px solid #d9d9d9;
            border-radius: 7px;
            padding: 8px;
            font-size: 16px;
        }
        input:active,
        input:focus {
            outline: none;
            border: 2px solid #afafaf;
        }
        button {
            display: block;
            position: absolute;
            right: 7px;
            top: 5px;
            background: none;
            border: none;
            outline: none;
            cursor: pointer;
            color: #848484;
        }
        button[disabled="disabled"] {
            opacity: 0.3;
        }
    </style>

    <!--***********************************************************-->

    <script>
        // mixin
        this.mixin(koeUIcore);

        // vars of View
        this.text = '';
        this.flag_firstMsgGet = false;
        this.c_polling = 0;
        this.polling_max = 30;
        this.msgAmount = 0;

        // function
        edit(e) {
            this.text = e.target.value;
        }
        // getのPromise版
        get_prms() {
            var that = this;
            return new Promise(function (resolve, reject) {
                // メッセージの取得
                that.getMessage(that.convID);
                resolve();
            });
        }
        send() {
            var that = this;
            return new Promise(function (resolve, reject) {
                // メッセージの送信
                that.sendMessage(that.convID, that.text, that.from);
                that.root.querySelectorAll('input')[0].value = '';
                resolve();
            });
        }
        send_and_polling() {

            var that = this;

            // メッセージの送信
            var d_send = this.send();
            d_send.then(function () {
                // ここでポーリング呼出
                that.polling();
            });
        }
        polling() {
            var that = this;
            return new Promise(function (resolve, reject) {
                Promise.all([that.get_prms(), that.sleep(300)])
                    .then(function () {

                        // 再帰処理
                        // カウンタが最大より、まだ小さい。and 新しいメッセージが取得されていない場合
                        if (that.c_polling < that.polling_max) {
                            that.c_polling++; //カウンタ更新
                            that.polling(); //再帰呼出し
                        } else {
                            console
                            that.c_polling = 0;
                            that.scrollToBottom();
                        }

                        // メッセージ数のチェック
                        if( that.msgAmount < that.msgObj.messages.length ){
                            that.scrollToBottom();
                        }
                        that.msgAmount = that.msgObj.messages.length;


                    });
                resolve();
            });
        }
        sleep(time) {
            return new Promise(function (resolve, reject) {
                setTimeout(function () {
                    resolve();
                }, time);
            });
        }
        filter_me(user) {
            if (user == this.from) {
                return "_me";
            }
        }
        scrollToBottom(){
            $(".messagesBox").animate({scrollTop: $(".messagesBox")[0].scrollHeight});
        }

        // update
        this.on('update', function () {

            // 初回呼出の処理
            if (this.convID && this.flag_firstMsgGet == false) {

                // メッセージの取得
                this.getMessage( this.convID, null, this.scrollToBottom );

                // flagオン
                this.flag_firstMsgGet = true;

            }

        });

    </script>

    <!--***********************************************************-->

</koe-ui-basicchat>
