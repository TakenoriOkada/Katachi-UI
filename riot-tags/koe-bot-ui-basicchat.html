<koe-bot-ui-basicchat>

    <!--***********************************************************-->

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <ul>
        <li>
            <span>Hi, I am a bot! How are you?</span>
        </li>
        <li each="{ msgObj.messages }">
            <span>{ text }</span>
        </li>
    </ul>


    <div>
        <form onsubmit="{ send_and_polling }">
            <input type="text" onkeyup="{ edit }">
            <button disabled="{ !text }">
                <i class="material-icons">send</i>
            </button>
        </form>
    </div>


    <!--***********************************************************-->

    <style scoped>
        :scope {
            display: block;
        }

        * {
            box-sizing: border-box;
        }

        ul {
            display: block;
            padding: 0;
            height: 200px;
            overflow: auto;
        }

        li {
            display: block;
            list-style: none;
        }

        li span {
            display: inline-block;
            background: #F1F0F0;
            padding: 5px 15px;
            border-radius: 20px;
        }

        form {
            display: block;
            position: relative;
        }

        input {
            display: block;
            width: 100%;
            border: 2px solid #d9d9d9;
            border-radius: 7px;
            padding: 8px;
            font-size: 16px;
        }

        input:active,
        input:focus {
            outline: none;
            border: 2px solid #afafaf;
        }

        button {
            display: block;
            position: absolute;
            right: 7px;
            top: 5px;
            background: none;
            border: none;
            outline: none;
            cursor: pointer;
            color: #848484;
        }

        button[disabled="disabled"] {
            opacity: 0.3;
        }
    </style>

    <!--***********************************************************-->

    <script>
        // mixin
        this.mixin(koeUIcore);

        // vars of view
        this.text = '';
        this.flag_firstMsgGet = false;
        this.c_polling = 0;
        this.polling_max = 5;

        // function
        edit(e) {
            this.text = e.target.value;
        }
        get() {
            // メッセージの取得
            this.getMessage(this.convID);
        }
        get_prms() {
            var that = this;
            return new Promise(function (resolve, reject) {
                // メッセージの取得
                that.getMessage(that.convID);
                resolve();
            });
        }
        send() {
            var that = this;
            return new Promise(function (resolve, reject) {
                // メッセージの送信
                that.sendMessage(that.convID, that.text, that.from);
                that.root.querySelectorAll('input')[0].value = '';
                resolve();
            });
        }
        send_and_polling() {

            var that = this;

            // メッセージの送信
            var d_send = this.send();
            d_send.then(function () {
                // ここでポーリング呼出
                that.polling();
            });
        }
        polling() {
            var that = this;
            return new Promise(function (resolve, reject) {
                Promise.all([that.get_prms(), that.sleep(1500)])
                    .then(function () {
                        if (that.c_polling < that.polling_max) {
                            that.c_polling++; //カウンタ更新
                            that.polling(); //再帰呼出し
                        }
                    });
                resolve();
            });
        }
        sleep(time) {
            return new Promise(function (resolve, reject) {
                setTimeout(function () {
                    resolve();
                }, time);
            });
        }
//        dammy() {
//            return new Promise(function (resolve, reject) {
//                console.log('dammy GET');
//                resolve();
//            });
//        }

        // bind
        this.on('update', function () {
            // 初回のメッセージ取得
            if (this.convID && this.flag_firstMsgGet == false) {

                // メッセージの取得
                this.getMessage(this.convID);
                // flagオン
                this.flag_firstMsgGet = true;
            }
        });
    </script>

    <!--***********************************************************-->

</koe-bot-ui-basicchat>
